<script src="http://ditu.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAJod3rJ1UD4NbyqMUYncq8hSJzhnW5idwQnMkpN3KtraAW36MXhQfv15HR27S30pNBsaozzpDAHB-QA" type="text/javascript"></script>
<%= javascript_include_tag("markerclusterer_packed") %>
<script type="text/javascript" src="/schools.json"></script>

<script type="text/javascript">
  var map;
  
  function initialize() {
    if (GBrowserIsCompatible()) {
      map = new GMap2(document.getElementById("map_div"));
      map.setCenter(new GLatLng(<%= @map_center[0].to_f %>, <%= @map_center[1].to_f %>), <%= @map_center[2] %>);
      map.addControl(new GLargeMapControl());
      map.addControl(new GMapTypeControl());

      var icon = new GIcon(G_DEFAULT_ICON);
      icon.image = "/images/marker.png";
      var markers = [];

      function markerClickFn(point, id) {
        return function() {
          GDownloadUrl("/schools/info_window/" + id, function(data, responseCode) {
            map.openInfoWindowHtml(point, data);
          });
        }
      }
      
      for (var i = 0; i < schools.length; ++i) {
        var point = new GLatLng(schools[i].la, schools[i].lo)
        var marker = new GMarker(point, {icon: icon});

        GEvent.addListener(marker, "click", markerClickFn(point, schools[i].i));

        markers.push(marker);
      }

      var markerCluster = new MarkerClusterer(map, markers);
    }
  }
  window.onload = initialize;
</script>

<div id="map_div" style="width: 600px; height: 600px"></div>